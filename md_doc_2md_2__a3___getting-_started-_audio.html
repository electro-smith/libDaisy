<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libDaisy: Getting Started - Audio</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" type="image/x-icon" href="ES_Circle_Orange.PNG">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html"><img alt="Logo" src="DaisyLogo.png"/></a>
  </td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libDaisy
   </div>
   <div id="projectbrief">Hardware Library for Daisy</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2md_2__a3___getting-_started-_audio.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Getting Started - Audio</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md21"></a> Audio is an essential part of the daisy ecosystem, but isn't entirely simple to work with if you're not used to writing code in general.</p>
<p>Let's breakdown how the audio on an embedded device like Daisy works, and go over how can start making sound immediatly with your daisy.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Analog and Digital Audio</h1>
<p>What is Analog Audio, and how is different from "digital audio"? These are just a few questions you may have wondered at one point or another.</p>
<p>Analog audio, as it pertains to Daisy, is a voltage that that goes into the audio input pins, or leaves the audio output pins. This is typically a line level signal, or has an accompanying circuit to convert it from one signal level to another (i.e. Modular level on the Daisy Patch, etc.).</p>
<p>Digital Audio is the representation of the signal while it's inside one of the devices on the daisy, in your computer, or stored on a drive somewhere in your room or office. Digital Audio can be represented a number of different ways, and is often discussed using the terms "sample rate", and "bit depth".</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Sample Rate</h2>
<p>Sample rate is the number of samples processed each second. Typical CDs are at 44.1kHz, while movies and other media have audio at 48kHz. That means that there are roughly 45-thousand discrete audio samples, or individual values, for each second of audio recorded.</p>
<p>High-fidelity samplerates start at 96kHz, and 192kHz, and can go even higher in measurement devices! The daisy's on board audio can run up to 96kHz.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Bit Depth</h2>
<p>Meanwhile, bit-depth is the term used to describe each of those individual values. Remember the 48000 samples per second? Well, what are they; Letters, numbers, and if so, what <em>kind</em> of number?</p>
<p>Well, typical CD audio is 16-bits, that means that for any single value there are 65536 potential "volume" levels that can be used to represent the signal. On the daisy, the hardware uses 24-bit audio which comes out to over 16.7 <b>million</b> values for a given sample.</p>
<p>On the other side of the spectrum, "Lo-Fi" audio would be something like 8-bit audio (found in early video game consoles, and elsewhere). In this case, there are only 256 potential values for a given sample.</p>
<p>The higher the bitdepth, the more dynamic range, and the less "digital" something may sound... to a point. (beyond 16-bits, the difference becomes less and less noticeable).</p>
<p>The bitdepths mentioned so far are known as "integer" formats, meaning that the values are represented as whole numbers. For example, a 16-bit sample would be a number between -32768 and 32767.</p>
<p>32-bit float bitdepth represents the numbers as floating point numbers. Daisy's audio engine uses 32-bit floats to work with audio, and converts to whatever the hardware connected to it wants. That said, by using only the <code>SaiHandle</code> without the <code>AudioHandle</code> it is possible to work with audio in the "fixed-point" formats mentioned above.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Block Size</h2>
<p>Digital audio is often handled in blocks, instead of acquiring, processing, and delivering one sample at a time. It is more efficient to do this, as the hardware takes a little bit of extra time to set up the transaction to acquire, and deliver new samples. When working with blocks, you can be filling a new group of samples while the last group is being sent through the hardware.</p>
<p>This is set up in side of the <code>AudioHandle</code> class, and doesn't require any special attention, but it is worth being aware of.</p>
<p>When working with extrememly large blocks, this can introduce some noticeable latency. However, with the sizes common to Daisy, the software latency this adds is usually around, or less than 1 millisecond (i.e. imperceivable).</p>
<p>For our examples below, we'll be using a very small block size of 4 samples so that we can visualize the data structures easily.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Making Some Sound</h1>
<p>If you're using the Daisy Seed, DaisyPatchSM, or any of the other boards that build off of one of those, the audio engine is set up under the hood, and all you have to do to start making some sound is create a callback.</p>
<p>So what is a callback? Well, a callback is a piece of code that will be "call"ed whenever a certain event happens. In the case of Daisy Audio, this is whenever the hardware is ready for more samples (those digital bits of audio we talked about earlier).</p>
<p>The daisy audio callback usually looks something like this:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="daisy__seed_8h.html">daisy_seed.h</a>&quot;</span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacedaisy.html">daisy</a>; <span class="comment">// to simplify syntax</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create our hardware object</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_daisy_seed.html">DaisySeed</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::InputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>, </div>
<div class="line">                <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::OutputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>, </div>
<div class="line">                <span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>) </div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Make sound here!</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">main</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>();</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.StartAudio(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>);</div>
<div class="line">    <span class="keywordflow">while</span>(1) {}</div>
<div class="line">}</div>
<div class="ttc" id="aclassdaisy_1_1_daisy_seed_html"><div class="ttname"><a href="classdaisy_1_1_daisy_seed.html">daisy::DaisySeed</a></div><div class="ttdoc">This is the higher-level interface for the Daisy board.   All basic peripheral configuration/initiali...</div><div class="ttdef"><b>Definition</b> daisy_seed.h:19</div></div>
<div class="ttc" id="aclassdaisy_1_1_led_driver_pca9685_html"><div class="ttname"><a href="classdaisy_1_1_led_driver_pca9685.html">daisy::LedDriverPca9685</a></div><div class="ttdef"><b>Definition</b> leddriver.h:33</div></div>
<div class="ttc" id="aclassdaisy_1_1_led_driver_pca9685_html_a468206d813cff0033a50e7ce613ad8cb"><div class="ttname"><a href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">daisy::LedDriverPca9685::Init</a></div><div class="ttdeci">void Init(I2CHandle i2c, const uint8_t(&amp;addresses)[numDrivers], DmaBuffer dma_buffer_a, DmaBuffer dma_buffer_b, dsy_gpio_pin oe_pin={DSY_GPIOX, 0})</div><div class="ttdef"><b>Definition</b> leddriver.h:65</div></div>
<div class="ttc" id="adaisy__seed_8h_html"><div class="ttname"><a href="daisy__seed_8h.html">daisy_seed.h</a></div></div>
<div class="ttc" id="anamespacedaisy_html"><div class="ttname"><a href="namespacedaisy.html">daisy</a></div><div class="ttdoc">Hardware defines and helpers for daisy field platform.</div><div class="ttdef"><b>Definition</b> index.h:2</div></div>
</div><!-- fragment --><p>The above example shows starting the audio engine, with our callback, but doesn't actually do anything with the sound coming in, or create any sound to go out.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Audio Output</h2>
<p>Where would we start if we wanted to make some sound? Well, there are two things we need to know if we want to <em>output</em> some sound.</p>
<ol type="1">
<li>What is "out", What is a AudioHandle::OutputBuffer?</li>
<li>What does size mean?</li>
</ol>
<p>Well, "out" are the samples that we can use to make sound, and "size" is the number of samples we have to fill. In other words, its our block size.</p>
<p>The out buffer is "non-interleaved" meaning that there are two "rows" of data, one for the left audio channel, and one for the right (or in the case of the Daisy Patch, there are four rows, one for each channel of audio).</p>
<p>If we want to write silence to all of the audio it would look something like:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::InputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>, </div>
<div class="line">                <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::OutputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>, </div>
<div class="line">                <span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>) </div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> = 0; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> &lt; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>++)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = 0.0f;</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = 0.0f;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// you can also use standard library functions if you&#39;re familiar with C++:</span></div>
<div class="line">    std::fill(&amp;<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][0], &amp;<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>], 0.0f);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Where the first bracket indicates the audio channel (0 for left, 1 for right).</p>
<p>We can loop through each sample, and choose what value it should be.</p>
<p>Since silence is boring, and creating an oscillator is a bit out of the scope of this guide, the <a href="https://github.com/electro-smith/DaisySP">DaisySP</a> DSP Library is full of objects that you can use to do things instead of silence, without having to know exactly what you're doing, or spending time writing DSP yourself.</p>
<p>For example, we can use the <code>daisysp::Oscillator</code> class to generate a tone. The defaults for Oscillator will be acceptable for this (it will generate a 100Hz sine wave). So we won't go in depth on what else this class can do right now.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="daisy__seed_8h.html">daisy_seed.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;daisysp.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacedaisy.html">daisy</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_daisy_seed.html">DaisySeed</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>;</div>
<div class="line">daisysp::Oscillator <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">osc</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::InputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>, </div>
<div class="line">                <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::OutputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>, </div>
<div class="line">                <span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>) </div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> = 0; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> &lt; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>++)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// The oscillator&#39;s Process function synthesizes, and</span></div>
<div class="line">        <span class="comment">// returns the next sample.</span></div>
<div class="line">        <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">osc</a>.Process();</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a>;</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">main</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>();</div>
<div class="line">    <span class="comment">// We initialize the oscillator with the sample rate of the hardware</span></div>
<div class="line">    <span class="comment">// this ensures that the frequency of the Oscillator will be accurate.</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">osc</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.AudioSampleRate());</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.StartAudio(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>);</div>
<div class="line">    <span class="keywordflow">while</span>(1) {}</div>
<div class="line">}</div>
</div><!-- fragment --><p>And with that, we have sound!</p>
<p>Now, working with the input isn't too much different.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Audio Input</h2>
<p>The input comes in the same way that the audio goes out, as arrays of floating point values.</p>
<p>If we simply want to pass audio through the Daisy without doing anything we just need to copy the data from the input buffer to the output buffer.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> = 0; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> &lt; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>++)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>];</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>];</div>
<div class="line">}</div>
</div><!-- fragment --><p>but what's the point in setting up all of this code to make something sound the same, let's use the oscillator we already added to make something interesting happen:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> = 0; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> &lt; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>++)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">osc</a>.Process();</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] * <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a>;</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] * <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">sine_signal</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now, whatever you send through the daisy is going to get multiplied by the 100Hz sine signal. Sounds pretty funky, right!? Well, that's a type of amplitude modulation known as ring modulation, which is a topic for another day, but it goes to show that with very little code, and some curiousity we can start to make some interesting things happen.</p>
<p><a href="https://github.com/electro-smith/DaisySP">DaisySP</a> is filled with other objects to filter, delay, bit crush, reverberate, and otherwise synthesize, and process sound, and can be a great stepping off point from here to making some interesting sounds.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Audio Data Packing</h2>
<p>On the daisy, there are two ways the audio data can be prepeared, "Interleaved" and "Non-Interleaved", the overall callback structure functions the same in either case, but the way the input and output data is packed is different in each one.</p>
<p>Above, we looked at the non-interleaved format, where each channel had its own array of samples.</p>
<p>Interleaved audio is instead one large array containing multiple channels of data. This data is interleaved so that there is a single sample of each channel before moving to the next sample. For example, with a block size of four, the full buffer would look like:</p>
<div class="fragment"><div class="line">{ L0, R0, L1, R1, L2, R2, L3, R3 }</div>
</div><!-- fragment --><p>as opposed to the non-interleaved version of the same data, that could be represented as:</p>
<div class="fragment"><div class="line">{ </div>
<div class="line">    { L0, L1, L2, L3 },</div>
<div class="line">    { R0, R1, R2, R3 }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md30"></a>
Changing Audio Settings</h1>
<p>The AudioHandle allows the user to change certain settings, in particular the:</p>
<ul>
<li>Sample Rate</li>
<li>Block Size</li>
</ul>
<p>On the DaisySeed, or other official boards you can use the following functions: </p><div class="fragment"><div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.SetAudioBlockSize(4);</div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.SetAudioSampleRate(SaiHandle::Config::SampleRate::SAI_48KHZ);</div>
</div><!-- fragment --><p>Block size can be any number up to 256.</p>
<p>See the <a class="el" href="structdaisy_1_1_sai_handle_1_1_config.html#adace22abaff171f0c459cff4a44026fc">SaiHandle::Config::SampleRate</a> enum for the available samplerate options. It's also worth mentioning that, depending on what codec is connected, not all options are compatible.</p>
<h1><a class="anchor" id="autotoc_md31"></a>
What Not to do in the Audio Callback</h1>
<p>The audio callback is in what's called and "Interrupt Handler" without going in depth on what that means here, it does mean that it the function <em>must</em> take less time than it takes to transfer out the audio buffer, otherwise your audio will start to have under-run errors, which cause digital artifacts in the audio path.</p>
<p>The amount of time can be calculated as <code>(1 / sample_rate) * block_size</code>. For example, with 48 sample block size at 48kHz, the function can take 1ms before underruns start to occur.</p>
<p>Now, that is a bit of a simplification, because chances are you'll be doing a few things in the main <code>while()</code> loop, but it does mean that you shouldn't do things that take an indeterminant amount of time.</p>
<p>These things include:</p>
<ul>
<li>calls to other peripheral blocking functions (i.e. DAC Write, SPI tranfer, etc.)</li>
<li>dynamic allocation like <code>malloc</code></li>
</ul>
<p>If you do need to trigger non-deterministic events from within the audio callback you can use a flag, or other mechanism that can be checked in the main loop. An overly simplified example of this might look like:</p>
<div class="fragment"><div class="line"><span class="comment">// Global:</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">action_flag</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In callback:</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">some_event</a>) <span class="comment">// like a button press, or something</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">action_flag</a> = <span class="keyword">true</span>; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// In main()</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span>(1) </div>
<div class="line">{</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">action_flag</a>) {</div>
<div class="line">        <span class="comment">// Do the big thing that can take a while</span></div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">initiate_big_transfer</a>();</div>
<div class="line">        <span class="comment">// and clear the flag</span></div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">action_flag</a> = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md32"></a>
How To Measure the Processing Load</h1>
<p>It is crucial to have a feeling of how much processing load your algorithm introduces and how much room for additions you still have. This can be done by measuring the execution time of the audio callback and comparing it to the available time. Daisy comes with a helper class to do this, the <code>CpuLoadMeter</code>.</p>
<p>To measure the CPU load, you would call <code>.OnBlockStart()</code> at the beginning, and <code>.OnBlockEnd()</code> at the end of your audio callback. The you can request the resulting load measurement and print it on a display or a serial connection. It is crucial to do the printing from the main loop, not the audio callback itself, as discussed before.</p>
<p>A complete example would look like this:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="daisy__seed_8h.html">daisy_seed.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;daisysp.h&quot;</span></div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacedaisy.html">daisy</a>;</div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_daisy_seed.html">DaisySeed</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>;</div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_cpu_load_meter.html">CpuLoadMeter</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">loadMeter</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::InputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">in</a>, </div>
<div class="line">                <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AudioHandle::OutputBuffer</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>, </div>
<div class="line">                <span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>) </div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">loadMeter</a>.OnBlockStart();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> = 0; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a> &lt; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">size</a>; <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>++)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// add your processing here</span></div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[0][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = 0.0f;</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">out</a>[1][<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">i</a>] = 0.0f;</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">loadMeter</a>.OnBlockEnd();</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">main</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// start logging to the serial connection</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.StartLog();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// initialize the load meter so that it knows what time is available for the processing:</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">loadMeter</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.AudioSampleRate(), <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.AudioBlockSize());</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// start the audio processing callback</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.StartAudio(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">MyCallback</a>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        <span class="comment">// get the current load (smoothed value and peak values)</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">avgLoad</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">cpuLoadMeter</a>.GetAvgCpuLoad();</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">maxLoad</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">cpuLoadMeter</a>.GetMaxCpuLoad();</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">minLoad</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">cpuLoadMeter</a>.GetMinCpuLoad();</div>
<div class="line">        <span class="comment">// print it to the serial connection (as percentages)</span></div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.PrintLine(<span class="stringliteral">&quot;Processing Load %:&quot;</span>);</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.PrintLine(<span class="stringliteral">&quot;Max: &quot;</span> <a class="code hl_define" href="group__logging__macros.html#gaa7cc11426d24168f3430b4b070291e7c">FLT_FMT3</a>, <a class="code hl_define" href="group__logging__macros.html#ga5aa9dc2e89ac7abbcaaffca896ce8d7c">FLT_VAR3</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">maxLoad</a> * 100.0f));</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.PrintLine(<span class="stringliteral">&quot;Avg: &quot;</span> <a class="code hl_define" href="group__logging__macros.html#gaa7cc11426d24168f3430b4b070291e7c">FLT_FMT3</a>, <a class="code hl_define" href="group__logging__macros.html#ga5aa9dc2e89ac7abbcaaffca896ce8d7c">FLT_VAR3</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">avgLoad</a> * 100.0f));</div>
<div class="line">        <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.PrintLine(<span class="stringliteral">&quot;Min: &quot;</span> <a class="code hl_define" href="group__logging__macros.html#gaa7cc11426d24168f3430b4b070291e7c">FLT_FMT3</a>, <a class="code hl_define" href="group__logging__macros.html#ga5aa9dc2e89ac7abbcaaffca896ce8d7c">FLT_VAR3</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">minLoad</a> * 100.0f));</div>
<div class="line">        <span class="comment">// don&#39;t spam the serial connection too much</span></div>
<div class="line">        System::Delay(500);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassdaisy_1_1_cpu_load_meter_html"><div class="ttname"><a href="classdaisy_1_1_cpu_load_meter.html">daisy::CpuLoadMeter</a></div><div class="ttdef"><b>Definition</b> CpuLoadMeter.h:19</div></div>
<div class="ttc" id="agroup__logging__macros_html_ga5aa9dc2e89ac7abbcaaffca896ce8d7c"><div class="ttname"><a href="group__logging__macros.html#ga5aa9dc2e89ac7abbcaaffca896ce8d7c">FLT_VAR3</a></div><div class="ttdeci">#define FLT_VAR3(_x)</div><div class="ttdef"><b>Definition</b> logger.h:58</div></div>
<div class="ttc" id="agroup__logging__macros_html_gaa7cc11426d24168f3430b4b070291e7c"><div class="ttname"><a href="group__logging__macros.html#gaa7cc11426d24168f3430b4b070291e7c">FLT_FMT3</a></div><div class="ttdeci">#define FLT_FMT3</div><div class="ttdef"><b>Definition</b> logger.h:55</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
  <!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
<script type="text/javascript">
  // script for doxygen 1.9.2
  $(function () {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    $(window).resize(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>