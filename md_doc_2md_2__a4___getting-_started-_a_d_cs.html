<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libDaisy: Getting Started - ADCs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" type="image/x-icon" href="ES_Circle_Orange.PNG">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html"><img alt="Logo" src="DaisyLogo.png"/></a>
  </td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libDaisy
   </div>
   <div id="projectbrief">Hardware Library for Daisy</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2md_2__a4___getting-_started-_a_d_cs.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Getting Started - ADCs</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md33"></a> ADC stands for Analog to Digital Converter. These are used to read in a variable signal. These variable signals can be anything from a potentiometer, photoresistor, external control voltage, etc.</p>
<p>On the Daisy, the ADC inputs expect a signal in the range of 0V to 3.3V, unless otherwise stated (e.g. The CV inputs on the Daisy Patch SM are set up to expect -5V to 5V, a common range for Modular Synthesizers).</p>
<p>In this tutorial we'll be using the Daisy Seed hardware, and we will go through the process of connecting a few inputs to one of the many available ADC pins.</p>
<h1><a class="anchor" id="autotoc_md34"></a>
The CPP Objects Used</h1>
<p>We'll be using the <code>DaisySeed</code>, it's internal <code>AdcHandle</code>, <code>Pin</code>, and <code>AdcChannelConfig</code> objects in the following sections.</p>
<p>If you're using a different Daisy SOM (i.e. DaisyPatchSM, etc.) this is handled within the board support files for all available inputs.</p>
<p>The <code>DaisySeed</code> object is a class that manages all of the hardware on the Seed board. All we need to do with it for now is initialize it.</p>
<p>The <code>AdcHandle</code> is a handler for the microcontroller's embedded Analog to Digital Converter. It is up to 16-bits, and can handle multiplexing several inputs.</p>
<p>The <code>Pin</code> class is used to describe a specific physical pin on the hardware. These objects are used to initialize GPIO, but are also used in the configuration of more complex peripherals and devices (i.e. ADCs, Shift Registers, etc.).</p>
<p>The <code>AdcChannelConfig</code> object is used to define each of the connections to the ADC, and the order in which the inputs will be read.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
The Hardware Connections</h1>
<p>For this tutorial all we'll need is:</p>
<ul>
<li>a few potentiometers like these <a href="https://www.electro-smith.com/parts/trimmer">9mm Plastic Shaft Pot with Pointers</a>, but any potentiometer should do the trick.</li>
</ul>
<p>To wire up the pot we'll want to connect pin 1 of the pot to GND, and pin 3 of the pot to 3v3_A, and the middle leg (pin 2) will now output a variable voltage from 0V to 3.3V; perfect for our expected input range.</p>
<p>When working with the Daisy and external hardware, <b>always connect the DGND and AGND pins outside of the Daisy</b></p>
<h1><a class="anchor" id="autotoc_md36"></a>
ADC Channel Config</h1>
<p>libDaisy uses the STM32 ADC1 peripheral, which is a single ADC with several multiplexed inputs.</p>
<p>This makes setting it up a little different than something like a GPIO, because the ADC will scan through all of the configured inputs in the background without taking up CPU time.</p>
<p>To define what connections are made we will use the <code>AdcChannelConfig</code> class.</p>
<p>The AdcChannelConfig has two possible initialization functions:</p>
<ul>
<li><code>InitSingle</code> - For configuring a single input to a single pin on the Daisy</li>
<li><code>InitMux</code> - For configuring several inputs from an external multiplexer (like CD4051) to a single pin on the Daisy</li>
</ul>
<p>Below we'll only be using the <code>InitSingle</code> function, but stay tuned for a guide for connecting a ton of controls using external multiplexer in the future.</p>
<p>The <code>InitSingle</code> function takes an old version of the Daisy's <code>Pin</code> object, but it is compatible with the new pins. So anywhere you see, <code><a class="el" href="structdsy__gpio__pin.html">dsy_gpio_pin</a></code> you can use the <code>Pin</code> object instead.</p>
<p>This structure, and the number of channels can then be passed to the <code>AdcHandle</code> to set everything up.</p>
<h1><a class="anchor" id="autotoc_md37"></a>
A Single Input</h1>
<p>Alright, enough talk. Let's plug some stuff in, and write some code!</p>
<p>We can take a look at all of the available ADC pins by looking at the <a href="https://github.com/electro-smith/DaisyWiki/wiki/2.-Daisy-Seed-Pinout">Pinout Diagram</a>. The ADC Pins are all labeled and colored in yellow.</p>
<p>Let's get started with pin <code>A0</code> (also known as <code>D15</code>), and wire up our potentiometer.</p>
<p>See the wiring mentioned above in the Hardware Connections for how to connect all of the legs of the pot, and take the wiper (middle leg), and connect that to the <code>A0</code> pin on the Daisy.</p>
<p>And here's a short program that will setup, and read from an ADC:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="daisy__seed_8h.html">daisy_seed.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacedaisy.html">daisy</a>;</div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacedaisy_1_1seed.html">daisy::seed</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create out Daisy Seed Hardware object</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_daisy_seed.html">DaisySeed</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">main</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Initialize the Daisy Seed hardware</span></div>
<div class="line">  <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Start logging for printing over serial</span></div>
<div class="line">  <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.StartLog();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create an ADC Channel Config object</span></div>
<div class="line">  <a class="code hl_struct" href="structdaisy_1_1_adc_channel_config.html">AdcChannelConfig</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">adc_config</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Set up the ADC config with a connection to pin A0</span></div>
<div class="line">  <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">adc_config</a>.InitSingle(A0);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize the ADC peripheral with that configuration</span></div>
<div class="line">  <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>(&amp;<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">adc_config</a>, 1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Start the ADC</span></div>
<div class="line">  <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.Start();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <span class="comment">// Read the first ADC that&#39;s configured. In our case, this is the only input.</span></div>
<div class="line">    <span class="keywordtype">int</span> value = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.Get(0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// In order to know that everything&#39;s working let&#39;s print that to a serial console:</span></div>
<div class="line">    <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.PrintLine(<span class="stringliteral">&quot;ADC Value: %d&quot;</span>, value);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Wait half a second (500 milliseconds)</span></div>
<div class="line">    System::Delay(500);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aclassdaisy_1_1_daisy_seed_html"><div class="ttname"><a href="classdaisy_1_1_daisy_seed.html">daisy::DaisySeed</a></div><div class="ttdoc">This is the higher-level interface for the Daisy board.   All basic peripheral configuration/initiali...</div><div class="ttdef"><b>Definition</b> daisy_seed.h:19</div></div>
<div class="ttc" id="aclassdaisy_1_1_led_driver_pca9685_html"><div class="ttname"><a href="classdaisy_1_1_led_driver_pca9685.html">daisy::LedDriverPca9685</a></div><div class="ttdef"><b>Definition</b> leddriver.h:33</div></div>
<div class="ttc" id="aclassdaisy_1_1_led_driver_pca9685_html_a468206d813cff0033a50e7ce613ad8cb"><div class="ttname"><a href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">daisy::LedDriverPca9685::Init</a></div><div class="ttdeci">void Init(I2CHandle i2c, const uint8_t(&amp;addresses)[numDrivers], DmaBuffer dma_buffer_a, DmaBuffer dma_buffer_b, dsy_gpio_pin oe_pin={DSY_GPIOX, 0})</div><div class="ttdef"><b>Definition</b> leddriver.h:65</div></div>
<div class="ttc" id="adaisy__seed_8h_html"><div class="ttname"><a href="daisy__seed_8h.html">daisy_seed.h</a></div></div>
<div class="ttc" id="anamespacedaisy_1_1seed_html"><div class="ttname"><a href="namespacedaisy_1_1seed.html">daisy::seed</a></div><div class="ttdef"><b>Definition</b> daisy_seed.h:195</div></div>
<div class="ttc" id="anamespacedaisy_html"><div class="ttname"><a href="namespacedaisy.html">daisy</a></div><div class="ttdoc">Hardware defines and helpers for daisy field platform.</div><div class="ttdef"><b>Definition</b> index.h:2</div></div>
<div class="ttc" id="astructdaisy_1_1_adc_channel_config_html"><div class="ttname"><a href="structdaisy_1_1_adc_channel_config.html">daisy::AdcChannelConfig</a></div><div class="ttdoc">Configuration Structure for an ADC Channel.</div><div class="ttdef"><b>Definition</b> adc.h:32</div></div>
</div><!-- fragment --><p>To find out more about the serial printing, and what software to use, see our <a class="el" href="md_doc_2md_2__a2___getting-_started-_serial-_printing.html">tutorial on working with Serial Printing</a>.</p>
<p>With the above program, you should see a number printing that moves from 0 to 65536 as you rotate the pot. Now, pots, and electronics aren't perfect. So there's a chance that this may not reach those extremes, or it might reach them slightly before the edges of the potentiometer's range. This will largely depend on the potentiometer you're using.</p>
<p>Now that's great and all, but it would be nicer to work with a number that is scaled between 0 and 1 instead (since that's more useful for doing other things).</p>
<p>We can actually get the value in that range instead by changing the line where we were doing:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> value = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.Get(0); <span class="comment">// value will be 0-65536</span></div>
</div><!-- fragment --><p>to this Instead:</p>
<div class="fragment"><div class="line"><span class="keywordtype">float</span> value = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.GetFloat(0); <span class="comment">// value will be 0.0 to 1.0</span></div>
</div><!-- fragment --><p>floating point numbers have a few peculiarities because of the hardware and memory requirements of an embedded project, but you can keep the serial printing by adding the following to the project Makefile:</p>
<div class="fragment"><div class="line">LDFLAGS += -u _printf_float</div>
</div><!-- fragment --><p>This isn't included by default because it increases the flash size by several kilobytes, and there are other ways to print floating point numbers (more info on this in the [serial printing tutorial](tutorial)).</p>
<h1><a class="anchor" id="autotoc_md38"></a>
Multiple Inputs</h1>
<p>Most things get better when you add more of whatever it is. The same goes for controls!</p>
<p>Now we've set up a single pot. So let's look at what it would look like to hook up two (or more).</p>
<p>Nearly everything will stay the same except instead of using a single <code>AdcChannelConfig</code>, we'll want to create one for each control we want to use. C and C++ have a mechanism for dealing with this known as an array. If you're not familiar, it is basically just an ordered list.</p>
<p>So for setting up two pots we'll change the initialization code to look a little more like:</p>
<div class="fragment"><div class="line"><span class="comment">// Create an array of two AdcChannelConfig objects</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">num_adc_channels</a> = 2;</div>
<div class="line"><a class="code hl_struct" href="structdaisy_1_1_adc_channel_config.html">AdcChannelConfig</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>[<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">num_adc_channels</a>];</div>
<div class="line"><span class="comment">// Initialize the first one connected to A0</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>[0].InitSingle(A0);</div>
<div class="line"><span class="comment">// Initialize the second one connected to A4</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>[1].InitSingle(A4);</div>
</div><!-- fragment --><p>And finally when we go to initialize the ADC itself, we can now omit the <code>&amp;</code> that we had to use before because it's an array of objects, and we want to make sure to update the total count that we passed in before:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>, <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">num_adc_channels</a>);</div>
</div><!-- fragment --><p>Now you can read from either input. If you want to read the pot connected to A0 you would use <code>hw.adc.Get(0)</code>, or <code>hw.adc.GetFloat(0)</code>, and if you want to read from the pot connected to A4, you would use <code>hw.adc.Get(1)</code>, or <code>hw.adc.GetFloat(1)</code>.</p>
<p>You'll notice that you access them by the order in which you initialized them, not by the number associated with the Pin.</p>
<h1><a class="anchor" id="autotoc_md39"></a>
Order To Chaos - Naming ADC Channels</h1>
<p>Once you have a lot of ADC channels, it can be difficult to remember which channel corresponds to which control. To solve this, you can use <code>enum</code>s to assign names to channels like this:</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">AdcChannel</a> {</div>
<div class="line">   <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">pitchKnob</a> = 0,</div>
<div class="line">   <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">pitchCv</a>,</div>
<div class="line">   <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">gainKnob</a>,</div>
<div class="line">   <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">gainCv</a>,</div>
<div class="line">   <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">NUM_ADC_CHANNELS</a></div>
<div class="line">}</div>
</div><!-- fragment --><p>Here, the first value is assigned to <code>0</code>and the others increment automatically. Interestingly, this logic can be used to automatically get the total number of channels you use, by adding one last value <code>NUM_ADC_CHANNELS</code>. Of course you could also specify the individual values by hand, just add <code>myKnob = 3,</code>.</p>
<p>Now you can make your code much easier to read - and maintain, should you decide to change the hardware connections later:</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="structdaisy_1_1_adc_channel_config.html">AdcChannelConfig</a> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>[<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">NUM_ADC_CHANNELS</a>];</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>[<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">pitchCv</a>].InitSingle(A0);</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.<a class="code hl_function" href="classdaisy_1_1_led_driver_pca9685.html#a468206d813cff0033a50e7ce613ad8cb">Init</a>(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">my_adc_config</a>, <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">NUM_ADC_CHANNELS</a>);</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">pitchCvValue</a> = <a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">hw</a>.adc.GetFloat(<a class="code hl_class" href="classdaisy_1_1_led_driver_pca9685.html">pitchCv</a>);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md40"></a>
Using Different Kinds of Inputs</h1>
<p>OK. So now we know what to do with one, or a few inputs that already conform to the expected input range.</p>
<p>In a future guide we'll look at using active and passive circuits to condition a signal to the best range for sending to the Daisy.</p>
<h1><a class="anchor" id="autotoc_md41"></a>
Further Reading</h1>
<p>Topics coming soon:</p>
<ul>
<li>Printing with USB</li>
<li>HID classes (Switch, Led, AnalogControl) and why we use them </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
  <!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
<script type="text/javascript">
  // script for doxygen 1.9.2
  $(function () {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    $(window).resize(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>