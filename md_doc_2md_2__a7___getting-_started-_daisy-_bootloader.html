<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libDaisy: Getting Started - Daisy Bootloader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" type="image/x-icon" href="ES_Circle_Orange.PNG">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html"><img alt="Logo" src="DaisyLogo.png"/></a>
  </td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libDaisy
   </div>
   <div id="projectbrief">Hardware Library for Daisy</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_doc_2md_2__a7___getting-_started-_daisy-_bootloader.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Getting Started - Daisy Bootloader</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md48"></a></p>
<p>In the context of embedded applications, a bootloader is a small program that runs on bootup and manages loading and even updating target applications. The update routine of the STM32H7's system bootloader can be accessed on the Daisy by resetting the device with the BOOT button held down. However, the built-in bootloader can only reprogram the chip's internal flash (128kB). With this setup, it's not so easy to store larger programs in non-volatile memory, and it's even harder to get them running. That's where the Daisy bootloader comes in.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
Advantages of the Daisy bootloader</h1>
<p>With the Daisy bootloader, you can easily run significantly larger programs (up to 480kB on SRAM and almost 8MB on QSPI flash). Execution from SRAM has comparable speed to the internal flash, while the QSPI flash is naturally a fair bit slower. The update process for end-users can also be made extremely simple with SD cards or USB drives; simply starting up the Daisy with media plugged in will launch a search for valid executable binaries.</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Flashing the bootloader</h1>
<p>With the latest version of libDaisy, you should be able to flash the bootloader using the <code>program-boot</code> rule within any project. The bootloader will reside in the internal flash like any normal application, so you'll need to go through the <a href="https://github.com/electro-smith/DaisyWiki/wiki/1.-Setting-Up-Your-Development-Environment#4a-flashing-the-daisy-via-usb">normal DFU procedure</a> before running <code>make program-boot</code>.</p>
<h1><a class="anchor" id="autotoc_md51"></a>
Generating programs for the bootloader</h1>
<p>To generate programs that can run from the bootloader, you only need one additional line in your makefile:</p>
<div class="fragment"><div class="line">APP_TYPE = BOOT_SRAM</div>
</div><!-- fragment --><p>The valid <code>APP_TYPE</code>s are <code>BOOT_SRAM</code> (runs program on the internal SRAM), <code>BOOT_QSPI</code> (runs programs on the QSPI flash chip), and <code>BOOT_NONE</code> (which just behaves like normal and is unable to run from the bootloader). Once you've added the desired app type, you'll need to recompile your project. It should be obvious from the memory usage output where your program will run. For example, when compiling for SRAM, you might see something like:</p>
<div class="fragment"><div class="line">Memory region         Used Size  Region Size  %age Used</div>
<div class="line">       FLASH:          0 GB       128 KB      0.00%</div>
<div class="line">     DTCMRAM:        7440 B       128 KB      5.68%</div>
<div class="line">        SRAM:       46000 B       512 KB      8.77%</div>
<div class="line">      RAM_D2_DMA:     16 KB        32 KB     50.00%</div>
<div class="line">      RAM_D2:          0 GB       256 KB      0.00%</div>
<div class="line">      RAM_D3:          0 GB        64 KB      0.00%</div>
<div class="line">     ITCMRAM:          0 GB        64 KB      0.00%</div>
<div class="line">       SDRAM:          0 GB        64 MB      0.00%</div>
<div class="line">   QSPIFLASH:          0 GB      7936 KB      0.00%</div>
</div><!-- fragment --><p>Notice the zero bytes used in FLASH, which is the chip's internal flash storage. Since the bootloader lives there, any program that you intend to run with it can't use that region.</p>
<p>Compiling for QSPI will move the program over into the QSPIFLASH region:</p>
<div class="fragment"><div class="line">Memory region         Used Size  Region Size  %age Used</div>
<div class="line">       FLASH:          0 GB       128 KB      0.00%</div>
<div class="line">     DTCMRAM:          0 GB       128 KB      0.00%</div>
<div class="line">        SRAM:        7440 B       512 KB      1.42%</div>
<div class="line">  RAM_D2_DMA:         16 KB        32 KB     50.00%</div>
<div class="line">      RAM_D2:          0 GB       256 KB      0.00%</div>
<div class="line">      RAM_D3:          0 GB        64 KB      0.00%</div>
<div class="line">     ITCMRAM:          0 GB        64 KB      0.00%</div>
<div class="line">       SDRAM:          0 GB        64 MB      0.00%</div>
<div class="line">   QSPIFLASH:       46000 B      7936 KB      0.57%</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md52"></a>
Flashing with the bootloader</h1>
<p>With your program compiled, you have a few options available for programming it using the bootloader:</p>
<h2><a class="anchor" id="autotoc_md53"></a>
DFU</h2>
<p>If the bootloader's LED is pulsing in the grace period, and the Daisy is connected to your computer via USB, you can run <code>make program-dfu</code>. The <code>APP_TYPE</code> will automatically adjust the DFU command to write to the correct address. Note that you'll have to change the app type back to <code>BOOT_NONE</code> or remove it to flash non-bootloader programs.</p>
<h2><a class="anchor" id="autotoc_md54"></a>
SD Card</h2>
<p>If your Daisy is connected to a micro SD card slot, you can just drag and drop the <code>.bin</code> file generated in your project's build folder onto the card. If you then plug it into the Daisy and restart it, the bootloader will automatically flash it to the QSPI chip.</p>
<p>At this time, the SD card needs to be fully wired up with all of the 4-bit data lines connected.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
USB Drive</h2>
<p>If your Daisy's external USB pins (D29 and D30) are connected to a USB port, you can follow the same process as SD cards above.</p>
<h1><a class="anchor" id="autotoc_md56"></a>
Custom linkers</h1>
<p>From the two examples above, you'll notice that the <code>BOOT_SRAM</code> type does not use any SRAM as RAM. Instead, it's all placed in DTCMRAM, which is only 128kB. The <code>BOOT_QSPI</code> does use the SRAM, but the program's execution can be a fair bit slower running from QSPI. Essentially, each configuration has its own trade-offs. If you want to customize those trade-offs, you can write your own linker to determine where each part of your program is placed.</p>
<p>For a starting point, you can look through the linkers provided in libDaisy's <code>core</code> folder. Non-bootloader programs running on internal flash are linked with the <code>STM32H750IB_flash.lds</code> script, while the other two <code>.lds</code> scripts handle their respective configurations. Right now, the Daisy bootloader will only accept QSPI and SRAM as valid locations for programs, so custom linkers must place the <code>.isr_vector</code> and <code>.text</code> sections in these regions.</p>
<h1><a class="anchor" id="autotoc_md57"></a>
Detailed Behavior</h1>
<p>Once flashed, the bootloader has a grace period of 2.5 seconds on startup indicated by sinusoidal LED blinks. During this time, it will listen for DFU transactions over USB and search any connected media for valid binaries. Once this period elapses, the bootloader will attempt to load a program and jump to it. If no program is present, it will simply wait in the grace period until a DFU transaction occurs. You can extend the grace period indefinitely by pressing the BOOT button (the bootloader will acknowledge the extension with a few rapid blinks).</p>
<p>Programs are stored on the QSPI flash chip that comes with every Daisy. The first four 64kB sectors are left untouched, though these may be used in the future for additional features. Sectors are erased in 64kB chunks, so if you plan to use the space beyond the program, ensure that the first address lies on a 64k boundary beyond the size of the program code. In the STM32H7's address space, QSPI flash lies at address <code>0x90000000</code>, so programs are stored at <code>0x90040000</code>.</p>
<p>The bootloader needs a portion of the SRAM for its own processes. It uses 32kB located at the end of the region, so any programs run from SRAM cannot be greater than 480kB. You are free to use this space for any normal RAM sections, however.</p>
<p>For SD cards and USB drives, the executable binary search is not very sophisticated &ndash; it simply scans through the files in the root directory of the connected media looking for a file with an extension of <code>.bin</code>. Once a <code>.bin</code> file is found, the search will cease and the binary will be verified as executable. If that check passes, the bootloader will compare the file to what's already stored in QSPI and flash it if the file isn't the same.</p>
<p>SD Cards, if present, are checked before USB drives. If a binary is found on the SD card, the USB drive will be skipped whether it was valid or not.</p>
<p>If any error is encountered in the bootloading process, the Daisy will emit a single SOS pattern on the user LED and then continue as normal. The primary cause of errors is invalid programs, which can be encountered after a DFU transaction or in a media search. If you see an SOS, double check any connected media for stray <code>.bin</code> files and make sure you're not uploading a program that's supposed to run on the internal flash. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
  <!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
<script type="text/javascript">
  // script for doxygen 1.9.2
  $(function () {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    $(window).resize(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
