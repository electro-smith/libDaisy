<!-- HTML header for doxygen 1.9.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libDaisy: SPI</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" type="image/x-icon" href="ES_Circle_Orange.PNG">
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo">
    <a href="index.html"><img alt="Logo" src="DaisyLogo.png"/></a>
  </td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libDaisy
   </div>
   <div id="projectbrief">Hardware Library for Daisy</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_doc_2md_2__a8___getting-_started-_s_p_i.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SPI</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md58"></a> SPI stands for Serial Peripheral Interface, and is a way for devices to talk to one another. The protocol is used with one device as the main device or the leader. All other devices are followers.</p>
<p>There are four pins generally used:</p><ul>
<li>MOSI: Main Out Serial In</li>
<li>MISO: Main In Serial Out</li>
<li>SCLK: Serial Clock</li>
<li>NSS: Serial Select (Chip Select)</li>
</ul>
<h1><a class="anchor" id="autotoc_md59"></a>
How to Use SPI</h1>
<p>First create your SpiHandle object and a Config struct to configure it. Set any configurations you want to change in the config object, then initialize the spi peripheral with it.</p>
<p>A typical Daisy Seed configuration might look like this</p>
<div class="fragment"><div class="line"><span class="comment">// SpiHandle object and Spi Configuration object</span></div>
<div class="line">SpiHandle spi_handle;</div>
<div class="line">SpiHandle::Config spi_conf;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set some configurations</span></div>
<div class="line">spi_conf.periph = SpiHandle::Peripheral::SPI_1;</div>
<div class="line">spi_conf.mode = SpiHandle::Mode::MASTER;</div>
<div class="line">spi_conf.direction = SpiHandle::Direction::TWO_LINES;</div>
<div class="line">spi_conf.nss = SpiHandle::NSS::NSS_HARD_OUTPUT;</div>
<div class="line">spi_conf.pin_config.sclk = Pin(PORTG, 11);</div>
<div class="line">spi_conf.pin_config.miso = Pin(PORTB, 4);</div>
<div class="line">spi_conf.pin_config.mosi = Pin(PORTB, 5);</div>
<div class="line">spi_conf.pin_config.nss = Pin(PORTG, 10);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize the handle using our configuration</span></div>
<div class="line">spi_handle.Init(spi_conf);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md60"></a>
Configuration</h2>
<p>The default configuration sets the common defaults for SPI peripherals. However some peripherals may require changing these. Some other configurations you'll have to set every time you use SPI.</p>
<p><code>spi_conf.peripheral</code> The peripheral to be used. Must be specified by the user. For example <code>SpiHandle::Config::Peripheral::SPI_2</code>. The Daisy has 6 different SPI peripherals available, each of which uses different pins. Refer to the pinout diagram for more details.</p>
<p><code>spi_conf.mode</code> Master or slave. The main device is in charge of the bus (sets the clock, and NSS), the other devices follow along. Most of the time the Daisy will be in charge of the bus.</p><ul>
<li><code>SpiHandle::Config::Mode::MASTER</code>. The Daisy runs the bus.</li>
<li><code>SpiHandle::Config::Mode::SLAVE</code>. The Daisy follows another device.</li>
</ul>
<p><code>spi_conf.pin_config</code> The pins to be used by this SPI peripheral. These will have to match the peripheral you choose. Must be specified by the user.</p>
<ul>
<li><code>spi_conf.pin_config.miso</code>: Main In Serial Out: The main device reads from this pin, and the others write to it.</li>
<li><code>spi_conf.pin_config.mosi</code>: Main Out Serial In: The main device writes to this pin, and the others read from it.</li>
<li><code>spi_conf.pin_config.sclk</code>: Serial Clock. The main device outputs a clock signal on this pin.</li>
<li><code>spi_conf.pin_config.nss</code>: Serial Select. The main device uses this to indicate data is being sent. Usually active low.</li>
</ul>
<p>If you're not using a pin (e.g. software NSS, or simplex communication) you can set it to <code>Pin()</code>.</p>
<p><code>spi_conf.direction</code> Which direction data will travel. Must be specified by the user.</p>
<ul>
<li><code>SpiHandle::Config::Direction::TWO_LINES</code>. Data goes both ways. Each line only goes one direction. i.e. MOSI -&gt; MISO and MISO &lt;- MOSI. This is full duplex.</li>
<li><code>SpiHandle::Config::Direction::TWO_LINES_TX_ONLY</code>. The Daisy will only send data. If Daisy's the main device: MOSI-&gt;. If the Daisy's a follower MISO-&gt;. This is simplex TX.</li>
<li><code>SpiHandle::Config::Direction::TWO_LINES_RX_ONLY</code>. The Daisy will only read data. If Daisy;s the main device MISO&lt;-. If Daisy's a follower MOSI&lt;-. This is simplex RX.</li>
<li><code>SpiHandle::Config::Direction::ONE_LINE</code>. Data goes both ways over one line. i.e. MOSI &lt;-&gt; MISO. This is half duplex.</li>
</ul>
<p><code>spi_conf.data_size</code> How many bits in each transmission. Defaults to 8. Must be in the range [4, 32] inclusive.</p>
<p><code>spi_conf.clock_polarity</code> Is the clock active low or high? (Determines if the "first" and "second" edges are rising or falling.)</p>
<ul>
<li><code>SpiHandle::Config::ClockPolarity::HIGH</code>. The clock is active high.</li>
<li><code>SpiHandle::Config::ClockPolarity::LOW</code>. The clock is active low.</li>
</ul>
<p>Defaults to <code>SpiHandle::Config::ClockPolarity::LOW</code>.</p>
<p><code>spi_conf.clock_phase</code> When is the data ready to be read? The "first edge" is when we transition <b>to</b> the clock polarity. The "second edge" is when we transition <b>away from</b> the clock polarity.</p>
<p>So if the polarity is low, the first edge is when the clock goes low. Again, if the polarity is low, the second edge is when the clock goes high.</p>
<ul>
<li><code>SpiHandle::Config::ClockPhase::ONE_EDGE</code> Data is read on the first edge.</li>
<li><code>SpiHandle::Config::ClockPhase::TWO_EDGE</code>. Data is read on the second edge.</li>
</ul>
<p>Defaults to <code>SpiHandle::Config::ClockPhase::ONE_EDGE</code>.</p>
<p><code>spi_conf.nss</code> Serial select mode. Must be set by the user.</p>
<ul>
<li><code>SpiHandle::Config::NSS::SOFT</code>. Serial select is handled in software. You can ignore the NSS pin.</li>
<li><code>SpiHandle::Config::NSS::HARD_INPUT</code>. The NSS pin is in use, and the Daisy is a follower.</li>
<li><code>SpiHandle::Config::NSS::HARD_OUTPUT</code>. The NSS pin is in use, and the Daisy is a leader.</li>
</ul>
<p><code>spi_conf.baud_prescaler</code> Division of the default clock rate. The clock rate is always 25MHz. So with a prescaler of 4 for example, the final clock rate is 25MHz / 4 = 6.25MHz.</p>
<p>Defaults to <code>SpiHandle::Config::BaudPrescaler::PS_8</code></p>
<h1><a class="anchor" id="autotoc_md61"></a>
Blocking Transmit and Receive</h1>
<p>Send / receive data in a blocking fashion. The code waits while the transmissions are taking place.</p>
<div class="fragment"><div class="line"><span class="comment">// send 4 bytes</span></div>
<div class="line">uint8_t buffer[4] = {0, 1, 2, 3};</div>
<div class="line">spi_handle.BlockingTransmit(buffer, 4);</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// receive 4 bytes</span></div>
<div class="line">uint8_t buffer[4];</div>
<div class="line">spi_handle.BlockingReceive(buffer, 4);</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// send and receive 4 bytes</span></div>
<div class="line">uint8_t tx_buffer[4] = {0, 1, 2, 3};</div>
<div class="line">uint8_t rx_buffer[4];</div>
<div class="line">spi_handle.BlockingTransmitAndReceive(tx_buffer, rx_buffer, 4);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md62"></a>
DMA Transmit and Receive</h1>
<p>Send / receive data using DMA (Direct Memory Access). This allows the hardware to handle the transmission in the background while the code is doing other things. i.e. it is non blocking.</p>
<p>You can also pass along a callback to be called when the transfer starts, another for when the transfer is over, and a pointer to some data to send those callbacks.</p>
<p><b>Note:</b> Your buffer has to be in the DMA section of memory, as well as in a global scope.</p>
<div class="fragment"><div class="line"><span class="comment">// buffer for sending data</span></div>
<div class="line">uint8_t <a class="code hl_define" href="group__utility.html#ga42cc36a89607437fe4bc26d3f7d57043">DMA_BUFFER_MEM_SECTION</a> buffer[4];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// fill the buffer 0, 1, 2, 3</span></div>
<div class="line"><span class="keywordflow">for</span>(uint8_t i = 0; i &lt; 4; i++)</div>
<div class="line">{</div>
<div class="line">    buffer[i] = i;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// transmit the data</span></div>
<div class="line">spi_handle.DmaTransmit(buffer, 4, NULL, NULL, NULL);</div>
<div class="ttc" id="agroup__utility_html_ga42cc36a89607437fe4bc26d3f7d57043"><div class="ttname"><a href="group__utility.html#ga42cc36a89607437fe4bc26d3f7d57043">DMA_BUFFER_MEM_SECTION</a></div><div class="ttdeci">#define DMA_BUFFER_MEM_SECTION</div><div class="ttdef"><b>Definition</b> daisy_core.h:25</div></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// receive 4 bytes. No callbacks or callback data.</span></div>
<div class="line">uint8_t <a class="code hl_define" href="group__utility.html#ga42cc36a89607437fe4bc26d3f7d57043">DMA_BUFFER_MEM_SECTION</a> buffer[4];</div>
<div class="line">spi_handle.DmaReceive(buffer, 4, NULL, NULL, NULL);</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// send and receive 4 bytes. No callbacks or callback data.</span></div>
<div class="line">uint8_t <a class="code hl_define" href="group__utility.html#ga42cc36a89607437fe4bc26d3f7d57043">DMA_BUFFER_MEM_SECTION</a> tx_buffer[4];</div>
<div class="line">uint8_t <a class="code hl_define" href="group__utility.html#ga42cc36a89607437fe4bc26d3f7d57043">DMA_BUFFER_MEM_SECTION</a> rx_buffer[4];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// fill the TX buffer 0, 1, 2, 3</span></div>
<div class="line"><span class="keywordflow">for</span>(uint8_t i = 0; i &lt; 4; i++)</div>
<div class="line">{</div>
<div class="line">   tx_buffer[i] = i;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// transmit and receive</span></div>
<div class="line">spi_handle.DmaTransmitAndReceive(tx_buffer, rx_buffer, 4, NULL, NULL, NULL);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
  <!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
<script type="text/javascript">
  // script for doxygen 1.9.2
  $(function () {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    $(window).resize(function () {
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>